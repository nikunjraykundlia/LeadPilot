<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeadPilot - Lead Generation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .animate-spin-slow {
            animation: spin 2s linear infinite;
        }
        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        .table-row:hover {
            background-color: #f8fafc;
            transform: translateX(2px);
            transition: all 0.2s ease;
        }
        .keyword-tag {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            transform: scale(1);
            transition: all 0.2s ease;
        }
        .keyword-tag:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .processing-overlay {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-search-location mr-3"></i>
                LeadPilot
            </h1>
            <p class="text-white/80 text-lg">Advanced lead generation system for Google Maps business data</p>
        </div>

        <!-- Main Card -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 fade-in relative">
            
            <!-- Processing Overlay -->
            <div id="processingOverlay" class="absolute inset-0 processing-overlay rounded-2xl hidden items-center justify-center z-10">
                <div class="bg-white rounded-lg p-6 shadow-lg text-center max-w-lg">
                    <div class="animate-spin-slow mb-4">
                        <i class="fas fa-cog text-4xl text-blue-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Processing Keywords</h3>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                        <div id="keywordProgressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    
                    <!-- Current Processing Info -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <span id="progressCounter">0 / 0</span> businesses completed
                            â€¢ <span id="elapsedTime">0s</span> elapsed
                        </p>
                        <p class="text-sm font-semibold text-blue-600">
                            Currently processing: <span id="currentProcessQuery">""</span>
                        </p>
                        <p class="text-sm text-gray-500 mt-1">
                            Business: <span id="currentBusinessName" class="font-medium">-</span>
                        </p>
                    </div>
                    
                    <!-- Keywords Status List -->
                    <div id="keywordsStatusList" class="text-left max-h-32 overflow-y-auto mb-4">
                        <!-- Keywords status will be populated here -->
                    </div>
                    
                    <button 
                        onclick="checkResults()"
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200"
                    >
                        <i class="fas fa-sync-alt mr-2"></i>Check Status
                    </button>
                    <button 
                        onclick="markAsFinished()"
                        class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200"
                    >
                        <i class="fas fa-check-circle mr-2"></i>Mark as Finished
                    </button>
                </div>
            </div>

            <!-- Keywords Section -->
            <div class="mb-6">
                <label class="block text-gray-700 font-semibold mb-3">
                    <i class="fas fa-tags mr-2"></i>Search Keywords
                </label>
                
                <!-- Keywords Input -->
                <div class="flex gap-2 mb-3">
                    <input 
                        type="text" 
                        id="keywordInput" 
                        placeholder="Enter keyword and press Enter (e.g., restaurants in New York)"
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    >
                    <button 
                        id="addKeywordBtn"
                        class="bg-blue-500 text-white px-4 py-3 rounded-lg hover:bg-blue-600 transition duration-200"
                    >
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- Keywords Display -->
                <div id="keywordsList" class="flex flex-wrap gap-2 min-h-[40px] p-3 border border-gray-200 rounded-lg bg-gray-50">
                    <span class="text-gray-500 text-sm" id="keywordsPlaceholder">Add keywords by typing and pressing Enter...</span>
                </div>
            </div>

            <!-- Settings Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-hashtag mr-2"></i>Target Count (per keyword)
                    </label>
                    <input 
                        type="number" 
                        id="targetCount" 
                        placeholder="50"
                        value="50"
                        min="1"
                        max="500"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    >
                </div>
                <div class="flex items-end">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="visitInternalPages" checked class="mr-3 scale-125">
                        <span class="text-gray-700">
                            <i class="fas fa-globe mr-2"></i>
                            Search internal pages for more details
                        </span>
                    </label>
                </div>
            </div>

            <!-- Start Button -->
            <button 
                id="startScraping" 
                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 rounded-lg font-semibold text-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition duration-200 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
            >
                <i class="fas fa-rocket mr-2"></i>
                Start Scraping
            </button>

            <!-- Progress Section -->
            <div id="progressSection" class="mt-6 hidden">
                <div class="bg-gray-200 rounded-full h-3 mb-4">
                    <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full progress-bar" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-sm text-gray-600">
                    <span id="progressText">Initializing scraper...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-table mr-2"></i>Latest Results
                </h2>
                <div class="flex gap-4">
                    <button 
                        id="downloadBtn" 
                        class="bg-green-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-green-600 transform hover:scale-105 transition duration-200 shadow-md"
                    >
                        <i class="fas fa-download mr-2"></i>Download Excel
                    </button>
                    <button 
                        id="newSearchBtn" 
                        class="bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-600 transform hover:scale-105 transition duration-200 shadow-md"
                    >
                        <i class="fas fa-plus mr-2"></i>New Search
                    </button>
                </div>
            </div>
            
            <div id="resultsContent" class="text-center text-gray-600">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Processing complete! Check files section below for download.</p>
            </div>
        </div>

        <!-- Files Management Section -->
        <div class="glass-effect rounded-2xl shadow-2xl p-8 fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-folder-open mr-2"></i>Generated Files
                </h2>
                <div class="flex gap-2">
                    <button 
                        id="clearMemoryBtn" 
                        class="bg-orange-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-orange-600 transform hover:scale-105 transition duration-200 shadow-md"
                        title="Clear all memory data"
                    >
                        <i class="fas fa-memory mr-2"></i>Clear Memory
                    </button>
                    <button 
                        id="refreshFiles" 
                        class="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-600 transform hover:scale-105 transition duration-200 shadow-md"
                    >
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
            
            <div id="filesList" class="space-y-3">
                <!-- Files will be loaded here -->
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="messageContainer" class="fixed top-4 right-4 z-50"></div>
    </div>

    <script>
        let keywords = [];
        let currentProcessId = null;
        let statusCheckInterval = null;
        let lastCompletedFile = null;

        // Show message function
        function showMessage(message, type = 'info') {
            const container = document.getElementById('messageContainer');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const messageDiv = document.createElement('div');
            messageDiv.className = `${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 fade-in`;
            messageDiv.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            container.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Keywords management
        function addKeyword(keyword) {
            if (!keyword.trim()) return;
            
            keyword = keyword.trim();
            if (keywords.includes(keyword)) {
                showMessage('Keyword already added', 'warning');
                return;
            }

            keywords.push(keyword);
            renderKeywords();
            document.getElementById('keywordInput').value = '';
        }

        function removeKeyword(keyword) {
            keywords = keywords.filter(k => k !== keyword);
            renderKeywords();
        }

        function renderKeywords() {
            const keywordsList = document.getElementById('keywordsList');
            
            if (keywords.length === 0) {
                keywordsList.innerHTML = '<span class="text-gray-500 text-sm" id="keywordsPlaceholder">Add keywords by typing and pressing Enter...</span>';
                return;
            }

            keywordsList.innerHTML = keywords.map(keyword => `
                <div class="keyword-tag text-white px-3 py-2 rounded-full flex items-center gap-2 text-sm font-medium">
                    <span>${keyword}</span>
                    <button 
                        onclick="removeKeyword('${keyword.replace(/'/g, "\\'")}')"
                        class="hover:bg-white hover:bg-opacity-20 rounded-full w-5 h-5 flex items-center justify-center transition duration-200"
                    >
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        // Keyword input handlers
        document.getElementById('keywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addKeyword(this.value);
            }
        });

        document.getElementById('addKeywordBtn').addEventListener('click', function() {
            addKeyword(document.getElementById('keywordInput').value);
        });

        // Check processing status on page load
        async function checkInitialStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (status.isProcessing) {
                    showProcessingOverlay(status);
                    startStatusChecking();
                }
            } catch (error) {
                console.log('No active process');
            }
        }

        // Show processing overlay with multiple keywords
        function showProcessingOverlay(status) {
            document.getElementById('processingOverlay').classList.remove('hidden');
            document.getElementById('processingOverlay').classList.add('flex');
            document.getElementById('startScraping').disabled = true;
            
            updateProcessingStatus(status);
        }

        // Update processing status display
        function updateProcessingStatus(status) {
            // Update progress info
            const totalKeywords = status.keywords ? status.keywords.length : status.currentKeywords?.length || 0;
            const completedKeywords = status.processedKeywords ? status.processedKeywords.length : 0;
            const progress = status.progress || 0;
            const currentBusinessCount = status.currentBusinessCount || 0;
            const totalTargetCount = status.totalTargetCount || 0;
            const currentBusinessName = status.currentBusinessName || '';
            
            document.getElementById('keywordProgressBar').style.width = `${progress}%`;
            document.getElementById('progressCounter').textContent = `${currentBusinessCount} / ${totalTargetCount} businesses`;
            document.getElementById('elapsedTime').textContent = formatElapsedTime(status.elapsed || 0);
            document.getElementById('currentProcessQuery').textContent = `"${status.currentQuery || ''}"`;
            document.getElementById('currentBusinessName').textContent = currentBusinessName || '-';
            
            // Update keywords status list
            updateKeywordsStatusList(status);
        }

        // Update keywords status list
        function updateKeywordsStatusList(status) {
            const statusList = document.getElementById('keywordsStatusList');
            const keywords = status.keywords || status.currentKeywords || [];
            const processedKeywords = status.processedKeywords || [];
            const currentIndex = status.currentKeywordIndex || 0;
            
            if (keywords.length === 0) return;
            
            statusList.innerHTML = keywords.map((keyword, index) => {
                let statusIcon, statusClass, statusText;
                
                if (processedKeywords.includes(keyword)) {
                    statusIcon = '<i class="fas fa-check-circle text-green-500"></i>';
                    statusClass = 'text-green-600';
                    statusText = 'Completed';
                } else if (index === currentIndex) {
                    statusIcon = '<i class="fas fa-spinner fa-spin text-blue-500"></i>';
                    statusClass = 'text-blue-600 font-semibold';
                    statusText = 'Processing...';
                } else {
                    statusIcon = '<i class="fas fa-clock text-gray-400"></i>';
                    statusClass = 'text-gray-500';
                    statusText = 'Waiting';
                }
                
                return `
                    <div class="flex items-center justify-between py-1 text-sm">
                        <span class="${statusClass}">${keyword}</span>
                        <span class="flex items-center gap-1">
                            ${statusIcon}
                            <span class="text-xs ${statusClass}">${statusText}</span>
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Hide processing overlay
        function hideProcessingOverlay() {
            document.getElementById('processingOverlay').classList.add('hidden');
            document.getElementById('processingOverlay').classList.remove('flex');
            document.getElementById('startScraping').disabled = false;
        }

        // Format elapsed time
        function formatElapsedTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}h ${minutes % 60}m`;
            } else if (minutes > 0) {
                return `${minutes}m ${seconds % 60}s`;
            } else {
                return `${seconds}s`;
            }
        }

        // Start status checking
        function startStatusChecking() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
            
            statusCheckInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/status');
                    const status = await response.json();
                    
                    if (status.isProcessing) {
                        updateProcessingStatus(status);
                    } else {
                        // Processing completed
                        clearInterval(statusCheckInterval);
                        hideProcessingOverlay();
                        
                        const completedCount = status.completedFiles?.length || 0;
                        const timeoutFiles = status.completedFiles?.filter(f => f.timeout) || [];
                        const partialFiles = status.completedFiles?.filter(f => f.partial) || [];
                        
                        if (completedCount > 0) {
                            if (timeoutFiles.length > 0 && partialFiles.length > 0) {
                                showMessage(`Process completed with issues! Generated ${completedCount} files (${timeoutFiles.length} timeout, ${partialFiles.length} partial).`, 'warning');
                            } else if (timeoutFiles.length > 0) {
                                showMessage(`Process completed with timeout! Generated ${completedCount} files (${timeoutFiles.length} with partial data due to timeout).`, 'warning');
                            } else if (partialFiles.length > 0) {
                                showMessage(`Process stopped! Generated ${completedCount} files (${partialFiles.length} with partial data).`, 'warning');
                            } else {
                                showMessage(`All keywords completed! Generated ${completedCount} Excel files.`, 'success');
                            }
                        } else {
                            showMessage('Processing completed!', 'success');
                        }
                        loadFiles(); // Refresh files list
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 3000); // Check every 3 seconds
        }

        // Check results manually
        async function checkResults() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                if (!status.isProcessing) {
                    hideProcessingOverlay();
                    const completedCount = status.completedFiles?.length || 0;
                    const timeoutFiles = status.completedFiles?.filter(f => f.timeout) || [];
                    const partialFiles = status.completedFiles?.filter(f => f.partial) || [];
                    
                    if (completedCount > 0) {
                        if (timeoutFiles.length > 0 && partialFiles.length > 0) {
                            showMessage(`Process completed with issues! Generated ${completedCount} files (${timeoutFiles.length} timeout, ${partialFiles.length} partial).`, 'warning');
                        } else if (timeoutFiles.length > 0) {
                            showMessage(`Process completed with timeout! Generated ${completedCount} files (${timeoutFiles.length} with partial data due to timeout).`, 'warning');
                        } else if (partialFiles.length > 0) {
                            showMessage(`Process stopped! Generated ${completedCount} files (${partialFiles.length} with partial data).`, 'warning');
                        } else {
                            showMessage(`All processes completed! Generated ${completedCount} files.`, 'success');
                        }
                    } else {
                        showMessage('Process completed!', 'success');
                    }
                    loadFiles();
                } else {
                    const progress = status.progress || 0;
                    const currentBusinessCount = status.currentBusinessCount || 0;
                    const totalTargetCount = status.totalTargetCount || 0;
                    showMessage(`Still processing... ${currentBusinessCount}/${totalTargetCount} businesses completed (${progress}%)`, 'info');
                    updateProcessingStatus(status);
                }
            } catch (error) {
                showMessage('Error checking status', 'error');
            }
        }

        // Mark as finished - stop processing and generate Excel with current data
        async function markAsFinished() {
            try {
                showMessage('Stopping process and generating files...', 'info');
                
                const response = await fetch('/api/finish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // Check if response is ok and contains JSON
                const contentType = response.headers.get('content-type');
                if (!response.ok || !contentType || !contentType.includes('application/json')) {
                    // If we get HTML instead of JSON, it's likely an error page
                    const text = await response.text();
                    if (text.includes('<')) {
                        throw new Error('Server returned HTML error page instead of JSON. The server may need to be restarted.');
                    }
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    clearInterval(statusCheckInterval);
                    hideProcessingOverlay();
                    
                    const completedCount = result.completedFiles?.length || 0;
                    if (completedCount > 0) {
                        showMessage(`Process stopped! Generated ${completedCount} files with processed data.`, 'success');
                    } else {
                        showMessage('Process stopped! No data was processed.', 'info');
                    }
                    loadFiles(); // Refresh files list
                } else {
                    throw new Error(result.error || 'Failed to stop process');
                }
            } catch (error) {
                console.error('Mark as finished error:', error);
                if (error.message.includes('HTML error page')) {
                    showMessage('Server error detected. Please restart the server and try again.', 'error');
                } else {
                    showMessage(`Error stopping process: ${error.message}`, 'error');
                }
            }
        }

        // Start scraping with multiple keywords (FIXED VERSION)
        document.getElementById('startScraping').addEventListener('click', async () => {
            const count = parseInt(document.getElementById('targetCount').value);
            const visitInternalPages = document.getElementById('visitInternalPages').checked;

            if (keywords.length === 0) {
                showMessage('Please add at least one keyword', 'error');
                return;
            }

            if (!count || count < 1 || count > 500) {
                showMessage('Please enter a valid count between 1 and 500', 'error');
                return;
            }

            try {
                showMessage(`Starting scrape for ${keywords.length} keywords...`, 'info');
                
                const response = await fetch('/api/scrape', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        keywords: keywords,  // Send as array
                        count,
                        visitInternalPages
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentProcessId = result.processId;
                    showProcessingOverlay({
                        keywords: result.keywords,
                        processedKeywords: [],
                        currentKeywordIndex: 0,
                        currentQuery: result.keywords[0],
                        currentCount: count,
                        elapsed: 0,
                        progress: 0,
                        completedFiles: []
                    });
                    startStatusChecking();
                    
                } else if (response.status === 429) {
                    // Another process is running
                    showMessage(result.error, 'warning');
                    if (result.currentProcess) {
                        showProcessingOverlay({
                            keywords: result.currentProcess.keywords || [],
                            processedKeywords: result.currentProcess.processedKeywords || [],
                            currentQuery: result.currentProcess.currentQuery || '',
                            elapsed: result.currentProcess.elapsed || 0,
                            progress: result.currentProcess.progress || 0
                        });
                        startStatusChecking();
                    }
                } else {
                    throw new Error(result.error || 'Scraping failed');
                }
            } catch (error) {
                showMessage(`Error starting scrape: ${error.message}`, 'error');
            }
        });

        // Load files
        async function loadFiles() {
            try {
                const response = await fetch('/api/files');
                const files = await response.json();
                
                const filesList = document.getElementById('filesList');
                
                if (files.length === 0) {
                    filesList.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-folder-open text-4xl mb-4"></i>
                            <p>No files generated yet. Start by scraping some data!</p>
                        </div>
                    `;
                    return;
                }

                filesList.innerHTML = files.map(file => `
                    <div class="bg-white rounded-lg p-4 shadow-sm border hover:shadow-md transition duration-200">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800 mb-1">
                                    <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                    ${file.filename}
                                    ${file.type === 'memory' ? '<span class="ml-2 text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">In Memory</span>' : ''}
                                    ${file.timeout ? '<span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded"><i class="fas fa-exclamation-triangle mr-1"></i>Timeout</span>' : ''}
                                    ${file.partial ? '<span class="ml-2 text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded"><i class="fas fa-stop-circle mr-1"></i>Partial</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600">
                                    ${file.keyword ? `<span class="mr-4"><i class="fas fa-keyword mr-1"></i>Keyword: ${file.keyword}</span>` : ''}
                                    ${file.resultCount ? `<span class="mr-4"><i class="fas fa-database mr-1"></i>${file.resultCount} records</span>` : ''}
                                    ${file.timeout ? `<span class="mr-4 text-yellow-600"><i class="fas fa-exclamation-triangle mr-1"></i>Partial data (timeout)</span>` : ''}
                                    ${file.partial ? `<span class="mr-4 text-orange-600"><i class="fas fa-stop-circle mr-1"></i>Partial data (stopped)</span>` : ''}
                                    <span class="mr-4">
                                        <i class="fas fa-weight mr-1"></i>
                                        ${file.type === 'memory' ? '~' + Math.round(file.size / 1024) + ' KB' : Math.round(file.size / 1024) + ' KB'}
                                    </span>
                                    <span>
                                        <i class="fas fa-calendar mr-1"></i>
                                        ${new Date(file.created).toLocaleDateString()} ${new Date(file.created).toLocaleTimeString()}
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2 ml-4">
                                <button 
                                    onclick="downloadFile('${file.keyword || file.filename}', '${file.type}')"
                                    class="bg-blue-500 text-white px-3 py-2 rounded-md hover:bg-blue-600 transition duration-200"
                                    title="Download"
                                >
                                    <i class="fas fa-download"></i>
                                </button>
                                <button 
                                    onclick="deleteFile('${file.keyword || file.filename}', '${file.type}')"
                                    class="bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition duration-200"
                                    title="Delete"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                showMessage(`Error loading files: ${error.message}`, 'error');
            }
        }

        // Download file
        function downloadFile(identifier, type) {
            if (type === 'memory') {
                // Download from memory using keyword
                window.location.href = `/api/download/${identifier}`;
            } else {
                // Download from disk using filename
                window.location.href = `/api/download/file/${identifier}`;
            }
            showMessage('Download started!', 'success');
        }

        // Delete file
        async function deleteFile(identifier, type) {
            if (!confirm('Are you sure you want to delete this file?')) {
                return;
            }

            try {
                let url;
                if (type === 'memory') {
                    url = `/api/memory/${identifier}`;
                } else {
                    url = `/api/files/${identifier}`;
                }

                const response = await fetch(url, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Delete failed');
                }
                
                const result = await response.json();
                showMessage(result.message || 'File deleted successfully!', 'success');
                loadFiles(); // Refresh the list
            } catch (error) {
                console.error('Delete error:', error);
                showMessage('Error deleting file: ' + error.message, 'error');
            }
        }

        // New search
        document.getElementById('newSearchBtn').addEventListener('click', () => {
            document.getElementById('resultsSection').classList.add('hidden');
            keywords = [];
            renderKeywords();
            document.getElementById('targetCount').value = '50';
        });

        // Refresh files
        document.getElementById('refreshFiles').addEventListener('click', loadFiles);

        // Clear memory
        document.getElementById('clearMemoryBtn').addEventListener('click', async () => {
            if (!confirm('Are you sure you want to clear all memory data? This will delete all scraped data stored in memory.')) {
                return;
            }

            try {
                const response = await fetch('/api/memory', {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error('Failed to clear memory');
                }
                
                const result = await response.json();
                showMessage(result.message || 'Memory cleared successfully!', 'success');
                loadFiles(); // Refresh the list
            } catch (error) {
                console.error('Clear memory error:', error);
                showMessage('Error clearing memory: ' + error.message, 'error');
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkInitialStatus();
            loadFiles();
            renderKeywords();
        });

        // Auto-refresh files every 30 seconds
        setInterval(loadFiles, 30000);
    </script>
</body>
</html>
